<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Geolocation and Google Maps API</title>
    <script src="http://maps.google.com/maps/api/js?sensor=true&libraries=geometry"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <script>


      function ConvertToJsonData(cinemaData) {
          var temp = JSON.parse(cinemaData);
          var jsonObj = [];

          for(i = 0; i < Object.keys(temp).length; ++i) {
              jsonObj[i] = JSON.parse(temp[i]);
          }
          return jsonObj;
      }

      function GetDistance(cinemaData, positionData) {
          var distance  = [];
          console.log(cinemaData);
          console.log(positionData);
           for(i = 0; i < cinemaData.length; ++i) {
               var p1 = new google.maps.LatLng(cinemaData[i].latitude, cinemaData[i].longitude);
               var p2 = new google.maps.LatLng(positionData.coords.latitude, positionData.coords.longitude);
               distance[i] = (google.maps.geometry.spherical.computeDistanceBetween(p1, p2) / 1000);
           }

           console.log(distance);

      }

      // success function
      function geolocationSuccess(position) {
          $.post("/cinemas", {}, function(data, status){
              if(status == "success") {
                var jsonCinemaData = ConvertToJsonData(data);
                  GetDistance(jsonCinemaData, position);
              } else {
                  console.log("error");
              }
          });
      }

      // error method
      function geolocationError(positionError) {
        console.log("failed " + positionError);
      }


      // geolocates user
      function geolocateUser() {
        // If the browser supports the Geolocation API
        if (navigator.geolocation) {
          var positionOptions = {
            enableHighAccuracy: true,
            timeout: 10 * 1000 // 10 seconds
          };
          navigator.geolocation.getCurrentPosition(geolocationSuccess, geolocationError, positionOptions);
        } else {
          geolocationError("failed to get geoleocation");
        }
      }


      window.onload = geolocateUser;
    </script>

  </head>
  <body>
    <h1>Basic example</h1>
    <div id="map"></div>
    <p><b>Address</b>: <span id="address"></span></p>
    <p id="error"></p>

  </body>
</html>
